<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel Admin - Recrutamento</title>
  <link rel="stylesheet" href="admin.css">
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
</head>
<body>

  <!-- TELA DE LOGIN -->
  <div class="container" id="loginScreen">
    <h2>Acesso Restrito</h2>
    <p style="color: #666; margin-bottom: 20px;">√Årea exclusiva do RH.</p>
    <input type="email" id="adminEmail" placeholder="E-mail do administrador" required>
    <input type="password" id="adminSenha" placeholder="Senha" required>
    <button onclick="fazerLogin()">Entrar no Painel</button>
    <p id="loginErro" style="color:red; margin-top: 15px; font-weight: bold;"></p>
  </div>

  <!-- TELA DO PAINEL DE CONTROLE -->
  <div class="container" id="dashboardScreen" style="display: none;">
    <button class="btn-sair" onclick="fazerLogout()">Sair do Sistema</button>
    <h2>Gest√£o de Candidatos</h2>
    
    <div class="filtros">
      <label style="font-weight: bold;">Filtrar por Cargo:</label>
      <select id="filtroCargo" onchange="carregarCandidatos()">
        <option value="Todos">Todos os cargos</option>
        <option value="Caixa">Operador de Caixa</option>
        <option value="Repositor">Repositor</option>
        <option value="A√ßougue">A√ßougueiro</option>
        <option value="Gerente">Gerente de Loja</option>
      </select>
    </div>

    <div style="overflow-x: auto;">
      <table style="min-width: 900px;">
        <thead>
          <tr>
            <th>Data de Envio</th>
            <th>Nome do Candidato</th>
            <th>Cargo Pretendido</th>
            <th>Idade / Sexo</th>
            <th>Contato</th>
            <th>Status</th> <!-- COLUNA NOVA -->
            <th>Anexos</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tabelaCorpo">
        </tbody>
      </table>
    </div>
  </div>

  <!-- JANELA MODAL DE AGENDAMENTO -->
  <div id="modalAgendamento" class="modal">
    <div class="modal-content">
      <h3 style="margin-top:0;">Agendar: <span id="candNomeT"></span></h3>
      
      <label>Data da Entrevista:</label>
      <input type="date" id="dataEntrevista">
      
      <label>Hor√°rio:</label>
      <input type="time" id="horaEntrevista">
      
      <label>Local/Endere√ßo:</label>
      <input type="text" id="localEntrevista" value="Supermercado - Setor de RH">
      
      <div style="display: flex; gap: 10px; margin-top: 10px;">
        <button class="btn-acao" style="background:#25D366;" onclick="enviarWhatsApp()">üì≤ WhatsApp</button>
        <button class="btn-acao" style="background:#0066cc;" onclick="enviarEmail()">üìß E-mail</button>
        <button class="btn-acao" style="background:#999;" onclick="fecharModal()">Cancelar</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <script>
    // ==========================================
    // 1. INICIALIZA√á√ÉO E CHAVES (COLE AS SUAS)
    // ==========================================
    const supabaseUrl = "https://xwidfuieyleqfddsupnl.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh3aWRmdWlleWxlcWZkZHN1cG5sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5Njg4NzAsImV4cCI6MjA4NzU0NDg3MH0.7OwPJNt7IOYXdjMh27gAlKz_vSwmsXD8iTJNNHXGBTs";
    
    const clienteSupabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    emailjs.init("lycdmjrdHE0nwBOTT");

    let candidatoAlvo = null;

    // ==========================================
    // 2. FUN√á√ïES DE AUTENTICA√á√ÉO
    // ==========================================
    async function checarSessao() {
      const { data: { session } } = await clienteSupabase.auth.getSession();
      if (session) {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('dashboardScreen').style.display = 'block';
        carregarCandidatos();
      } else {
        document.getElementById('loginScreen').style.display = 'block';
      }
    }
    checarSessao();

    async function fazerLogin() {
      const email = document.getElementById('adminEmail').value;
      const senha = document.getElementById('adminSenha').value;
      const msgerro = document.getElementById('loginErro');
      msgerro.innerText = "Entrando...";
      msgerro.style.color = "blue";
      
      const { error } = await clienteSupabase.auth.signInWithPassword({ email, password: senha });
      if (error) {
        msgerro.innerText = 'Erro: E-mail ou senha inv√°lidos.';
        msgerro.style.color = "red";
      } else {
        location.reload(); 
      }
    }

    async function fazerLogout() {
      await clienteSupabase.auth.signOut();
      location.reload();
    }

    // ==========================================
    // 3. O DASHBOARD (RENDERIZAR TABELA)
    // ==========================================
    async function carregarCandidatos() {
      const filtro = document.getElementById('filtroCargo').value;
      const tbody = document.getElementById('tabelaCorpo');
      
      tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Buscando curr√≠culos...</td></tr>';

      let query = clienteSupabase.from('candidatos').select('*').order('criado_em', { ascending: false });
      
      if (filtro !== 'Todos') query = query.eq('cargo', filtro);

      const { data: candidatos, error } = await query;

      if (error || candidatos.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #666;">Nenhum candidato encontrado.</td></tr>';
        return;
      }

      tbody.innerHTML = '';
      
      candidatos.forEach(cand => {
        const dataFormatada = new Date(cand.criado_em).toLocaleDateString('pt-BR');
        
        // Garante que se estiver vazio, fique como 'Novo'
        const statusAtual = cand.status || 'Novo'; 
        // Cria a classe CSS baseada no status (ex: "Entrevista Agendada" vira "status-entrevista-agendada")
        const classeStatus = 'status-' + statusAtual.toLowerCase().replace(/\s+/g, '-');

        const tr = document.createElement('tr');
        
        // Renderiza a linha com o Select de Status e bot√µes (note que agora passo o ID pro modal)
        tr.innerHTML = `
          <td>${dataFormatada}</td>
          <td><strong>${cand.nome}</strong></td>
          <td>${cand.cargo}</td>
          <td>${cand.idade} anos<br><small>${cand.sexo}</small></td>
          <td>${cand.telefone}<br><small>${cand.email}</small></td>
          
          <td>
            <select class="select-status ${classeStatus}" onchange="mudarStatus('${cand.id}', this.value, this)">
              <option value="Novo" ${statusAtual === 'Novo' ? 'selected' : ''}>Novo</option>
              <option value="Entrevista Agendada" ${statusAtual === 'Entrevista Agendada' ? 'selected' : ''}>Entrevista Agendada</option>
              <option value="Contratado" ${statusAtual === 'Contratado' ? 'selected' : ''}>Contratado</option>
              <option value="Reprovado" ${statusAtual === 'Reprovado' ? 'selected' : ''}>Reprovado</option>
            </select>
          </td>

          <td>
            <a href="${cand.curriculo_url}" target="_blank" style="color: #0066cc; text-decoration: none; font-weight: bold; margin-bottom: 5px; display: inline-block;">üìÑ CV</a><br>
            <a href="${cand.video_url}" target="_blank" style="color: #27ae60; text-decoration: none; font-weight: bold; margin-bottom: 5px; display: inline-block;">üé• V√≠deo</a>
          </td>
          <td>
            <button class="btn-acao btn-agendar" onclick="abrirModal('${cand.id}', '${cand.nome}', '${cand.telefone}', '${cand.email}', '${cand.cargo}')">Agendar</button>
            <button class="btn-acao btn-excluir" onclick="deletarCandidato('${cand.id}', '${cand.nome}', '${cand.curriculo_url}', '${cand.video_url}')">Excluir</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ==========================================
    // 4. FUN√á√ïES DE A√á√ÉO (STATUS, EXCLUIR, AGENDAR)
    // ==========================================
    
    // Altera o Status no Banco de Dados
    async function mudarStatus(id, novoStatus, elementoSelect) {
      // Muda a cor na hora visualmente
      elementoSelect.className = 'select-status status-' + novoStatus.toLowerCase().replace(/\s+/g, '-');
      
      const { error } = await clienteSupabase.from('candidatos').update({ status: novoStatus }).eq('id', id);
      
      if (error) {
        alert("Erro ao salvar status: " + error.message);
        carregarCandidatos(); // Recarrega se der erro para voltar ao normal
      }
    }

        // Fun√ß√£o de Exclus√£o (Arquivos + Banco de Dados)
    async function deletarCandidato(id, nome, curriculoUrl, videoUrl) {
      if(!confirm(`‚ö†Ô∏è Tem certeza que deseja excluir ${nome} e APAGAR permanentemente os arquivos (CV e V√≠deo)?`)) return;
      
      // A URL √© longa (ex: https://.../arquivos/123-cv.pdf). O split('/').pop() pega s√≥ a √∫ltima parte.
      const nomeCv = curriculoUrl.split('/').pop().split('?')[0];
      const nomeVideo = videoUrl.split('/').pop().split('?')[0];

      // 2. Deletar arquivos f√≠sicos no Storage PRIMEIRO
      const { error: storageError } = await clienteSupabase.storage
        .from('arquivos')
        .remove([nomeCv, nomeVideo]);

      if (storageError) {
        console.warn("Aviso (Storage):", storageError.message);
        // N√£o paramos o c√≥digo aqui, pois se o arquivo j√° n√£o existir, 
        // queremos garantir que a linha da tabela suma mesmo assim.
      }

      // 3. Deletar o registro no Banco de Dados DEPOIS
      const { error: dbError } = await clienteSupabase.from('candidatos').delete().eq('id', id);
      
      if(dbError) {
        alert("Erro ao excluir do banco de dados: " + dbError.message);
      } else {
        carregarCandidatos(); // Atualiza a tela em tempo real
      }
    }

    function abrirModal(id, nome, telefone, email, cargo) {
      candidatoAlvo = { id, nome, telefone, email, cargo }; // Note que adicionei o ID aqui
      document.getElementById('candNomeT').innerText = nome;
      document.getElementById('modalAgendamento').style.display = 'flex';
    }

    function fecharModal() {
      document.getElementById('modalAgendamento').style.display = 'none';
    }

    function enviarWhatsApp() {
      const data = document.getElementById('dataEntrevista').value;
      const hora = document.getElementById('horaEntrevista').value;
      const local = document.getElementById('localEntrevista').value;

      if(!data || !hora) return alert("Preencha a data e o hor√°rio.");

      // Automa√ß√£o PR√ì-ATIVA: Atualiza status para Entrevista Agendada no banco silenciosamente!
      mudarStatus(candidatoAlvo.id, 'Entrevista Agendada', document.createElement('select')); 

      const dataBr = data.split('-').reverse().join('/');
      const numeroLimpo = candidatoAlvo.telefone.replace(/\D/g, ''); 
      const mensagem = `Ol√° ${candidatoAlvo.nome}, tudo bem? Aqui √© do setor de RH.\n\nAnalisamos seu curr√≠culo para a vaga de *${candidatoAlvo.cargo}* e voc√™ foi selecionado(a) para uma entrevista! üéâ\n\nüóìÔ∏è *Data:* ${dataBr}\n‚è∞ *Hor√°rio:* ${hora}\nüìç *Local:* ${local}\n\nPor favor, confirme sua presen√ßa.`;

      window.open(`https://wa.me/55${numeroLimpo}?text=${encodeURIComponent(mensagem)}`, '_blank');
      fecharModal();
      carregarCandidatos(); // Atualiza a tela
    }

    async function enviarEmail() {
      const data = document.getElementById('dataEntrevista').value;
      const hora = document.getElementById('horaEntrevista').value;
      const local = document.getElementById('localEntrevista').value;

      if(!data || !hora) return alert("Preencha a data e o hor√°rio.");
      
      const dataBr = data.split('-').reverse().join('/');
      const btnEmail = event.target;
      btnEmail.innerText = "Enviando...";
      btnEmail.disabled = true;

      try {
        await emailjs.send("service_dnul1wp", "template_h80jzoq", {
          email_candidato: candidatoAlvo.email,
          nome_candidato: candidatoAlvo.nome,
          cargo: candidatoAlvo.cargo,
          data: dataBr,
          hora: hora,
          local: local
        });
        
        // Automa√ß√£o: Atualiza o status automaticamente
        await mudarStatus(candidatoAlvo.id, 'Entrevista Agendada', document.createElement('select'));
        
        alert("E-mail de entrevista enviado com sucesso!");
        fecharModal();
        carregarCandidatos(); // Atualiza a tela
      } catch (error) {
        alert("Erro ao enviar o e-mail.");
        console.error(error);
      } finally {
        btnEmail.innerText = "üìß E-mail";
        btnEmail.disabled = false;
      }
    }
  </script>
</body>
</html>