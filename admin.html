<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel Admin - Recrutamento</title>
  <link rel="stylesheet" href="admin.css"> <!-- O CSS que criamos antes -->
</head>
<body>

  <!-- TELA DE LOGIN -->
  <div class="container" id="loginScreen">
    <h2>Acesso Restrito</h2>
    <p style="color: #666; margin-bottom: 20px;">√Årea exclusiva do RH.</p>
    <input type="email" id="adminEmail" placeholder="E-mail do administrador" required>
    <input type="password" id="adminSenha" placeholder="Senha" required>
    <button onclick="fazerLogin()">Entrar no Painel</button>
    <p id="loginErro" style="color:red; margin-top: 15px; font-weight: bold;"></p>
  </div>

  <!-- TELA DO PAINEL DE CONTROLE (Oculta at√© fazer login) -->
  <div class="container" id="dashboardScreen" style="display: none;">
    <button class="btn-sair" onclick="fazerLogout()">Sair do Sistema</button>
    <h2>Gest√£o de Candidatos</h2>
    
    <div class="filtros">
      <label style="font-weight: bold;">Filtrar por Cargo:</label>
      <select id="filtroCargo" onchange="carregarCandidatos()">
        <option value="Todos">Todos os cargos</option>
        <option value="Caixa">Operador de Caixa</option>
        <option value="Repositor">Repositor</option>
        <option value="A√ßougue">A√ßougueiro</option>
        <option value="Gerente">Gerente de Loja</option>
      </select>
    </div>

    <!-- Tabela Responsiva (Usar overflow-x e min-width resolve bugs no celular) -->
    <div style="overflow-x: auto;">
      <table style="min-width: 800px;">
        <thead>
          <tr>
            <th>Data de Envio</th>
            <th>Nome do Candidato</th>
            <th>Cargo Pretendido</th>
            <th>Idade / Sexo</th>
            <th>Contato</th>
            <th>Anexos (Arquivos)</th>
          </tr>
        </thead>
        <tbody id="tabelaCorpo">
          <!-- Dados renderizados aqui -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Biliotecas Importantes do JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <script>
    // 1. INICIALIZA√á√ÉO
    // ‚ö†Ô∏è ATEN√á√ÉO: N√ÉO ESQUE√áA DE COLAR A SUA URL E A SUA CHAVE ANON AQUI:
    const supabaseUrl = "https://xwidfuieyleqfddsupnl.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh3aWRmdWlleWxlcWZkZHN1cG5sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5Njg4NzAsImV4cCI6MjA4NzU0NDg3MH0.7OwPJNt7IOYXdjMh27gAlKz_vSwmsXD8iTJNNHXGBTs";

    const clienteSupabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    // 2. FUN√á√ÉO: Verificar se j√° est√° logado
    // Roda automaticamente assim que a p√°gina admin.html abre
    async function checarSessao() {
      const { data: { session } } = await clienteSupabase.auth.getSession();
      
      if (session) {
        // Se j√° est√° logado, esconde a tela de login e mostra a tela do painel
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('dashboardScreen').style.display = 'block';
        carregarCandidatos();
      } else {
        // Se N√ÉO est√° logado, deixa a tela de login vis√≠vel (que √© o padr√£o do CSS)
        document.getElementById('loginScreen').style.display = 'block';
      }
    }
    
    // Chama a fun√ß√£o para rodar a checagem
    checarSessao();

    // 3. FUN√á√ÉO: Fazer Login (Quando clica no bot√£o "Entrar")
    async function fazerLogin() {
      const email = document.getElementById('adminEmail').value;
      const senha = document.getElementById('adminSenha').value;
      const msgerro = document.getElementById('loginErro');
      
      msgerro.innerText = "Entrando...";
      msgerro.style.color = "blue";
      
      const { data, error } = await clienteSupabase.auth.signInWithPassword({ 
        email: email, 
        password: senha 
      });
      
      if (error) {
        msgerro.innerText = 'Erro: E-mail ou senha inv√°lidos. Tente novamente.';
        msgerro.style.color = "red";
        console.error(error.message);
      } else {
        // Se o login deu certo, a gente recarrega a p√°gina.
        // Ao recarregar, o 'checarSessao()' (acima) vai ver que a pessoa tem um "cookie" (Sess√£o) e j√° joga ela pro painel.
        location.reload(); 
      }
    }

    // 4. FUN√á√ÉO: Fazer Logout
    async function fazerLogout() {
      await clienteSupabase.auth.signOut();
      // Ao deslogar, o "cookie" morre e a p√°gina √© atualizada para mostrar o login
      location.reload();
    }

    // 5. FUN√á√ÉO: Carregar Candidatos da Tabela (O c√©rebro do Dash)
    async function carregarCandidatos() {
      const filtro = document.getElementById('filtroCargo').value;
      const tbody = document.getElementById('tabelaCorpo');
      
      tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Buscando curr√≠culos...</td></tr>';

      // Essa Query pega TODAS as colunas (*) da tabela 'candidatos'
      // O 'order' faz a ordena√ß√£o pela data (mais recentes no topo)
      let query = clienteSupabase.from('candidatos').select('*').order('criado_em', { ascending: false });
      
      // Se a pessoa selecionou um cargo espec√≠fico (ex: A√ßougue), a gente adiciona um 'filtro' (eq = equals = igual) na query
      if (filtro !== 'Todos') {
        query = query.eq('cargo', filtro);
      }

      // Agora a gente MANDA a query para o Supabase e espera os dados voltarem
      const { data: candidatos, error } = await query;

      if (error) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: red;">Erro ao buscar dados. Tente novamente.</td></tr>';
        console.error("Erro ao buscar dados:", error);
        return;
      }

      if (candidatos.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">Nenhum candidato encontrado.</td></tr>';
        return;
      }

      // Limpa a tabela para n√£o duplicar dados
      tbody.innerHTML = '';
      
      // 'forEach' pega um candidato de cada vez na lista de dados que chegou do banco e transforma em uma linha da tabela (<tr>)
      candidatos.forEach(cand => {
        // Formata a data (que est√° no formato do banco) para o padr√£o brasileiro DD/MM/AAAA
        const dataFormatada = new Date(cand.criado_em).toLocaleDateString('pt-BR');
        
        const tr = document.createElement('tr');
        
        // Aqui dentro a gente 'costura' o HTML usando os valores din√¢micos (${variavel})
        tr.innerHTML = `
          <td>${dataFormatada}</td>
          <td><strong>${cand.nome}</strong></td>
          <td>${cand.cargo}</td>
          <td>${cand.idade} anos<br><small>${cand.sexo}</small></td>
          <td>${cand.telefone}<br><small>${cand.email}</small></td>
          <td>
            <a href="${cand.curriculo_url}" target="_blank" style="color: #0066cc; text-decoration: none; font-weight: bold; margin-bottom: 5px; display: inline-block;">üìÑ Curr√≠culo</a><br>
            <a href="${cand.video_url}" target="_blank" style="color: #27ae60; text-decoration: none; font-weight: bold; display: inline-block;">üé• V√≠deo</a>
          </td>
        `;
        
        // Adiciona a linha novinha em folha no final da tabela
        tbody.appendChild(tr);
      });
    }
  </script>
</body>
</html>