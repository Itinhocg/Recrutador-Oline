<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel Admin - Recrutamento</title>
  <link rel="stylesheet" href="admin.css">
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
</head>
<body>

  <!-- TELA DE LOGIN -->
  <div class="container" id="loginScreen">
    <h2>Acesso Restrito</h2>
    <p style="color: #666; margin-bottom: 20px;">√Årea exclusiva do RH.</p>
    <input type="email" id="adminEmail" placeholder="E-mail do administrador" required>
    <input type="password" id="adminSenha" placeholder="Senha" required>
    <button onclick="fazerLogin()">Entrar no Painel</button>
    <p id="loginErro" style="color:red; margin-top: 15px; font-weight: bold;"></p>
  </div>

  <!-- TELA DO PAINEL DE CONTROLE -->
  <div class="container" id="dashboardScreen" style="display: none;">
    <button class="btn-sair" onclick="fazerLogout()">Sair do Sistema</button>
    <h2>Gest√£o de Candidatos</h2>
    
    <div class="filtros">
      <label style="font-weight: bold;">Filtrar por Cargo:</label>
      <select id="filtroCargo" onchange="carregarCandidatos()">
        <option value="Todos">Todos os cargos</option>
        <option value="Caixa">Operador de Caixa</option>
        <option value="Repositor">Repositor</option>
        <option value="A√ßougue">A√ßougueiro</option>
        <option value="Gerente">Gerente de Loja</option>
      </select>
    </div>

    <div style="overflow-x: auto;">
      <table style="min-width: 800px;">
        <thead>
          <tr>
            <th>Data de Envio</th>
            <th>Nome do Candidato</th>
            <th>Cargo Pretendido</th>
            <th>Idade / Sexo</th>
            <th>Contato</th>
            <th>Anexos</th>
            <th>A√ß√µes</th> <!-- COLUNA NOVA -->
          </tr>
        </thead>
        <tbody id="tabelaCorpo">
        </tbody>
      </table>
    </div>
  </div>

  <!-- JANELA MODAL DE AGENDAMENTO -->
  <div id="modalAgendamento" class="modal">
    <div class="modal-content">
      <h3 style="margin-top:0;">Agendar: <span id="candNomeT"></span></h3>
      
      <label>Data da Entrevista:</label>
      <input type="date" id="dataEntrevista">
      
      <label>Hor√°rio:</label>
      <input type="time" id="horaEntrevista">
      
      <label>Local/Endere√ßo:</label>
      <input type="text" id="localEntrevista" value="Supermercado - Setor de RH">
      
      <div style="display: flex; gap: 10px; margin-top: 10px;">
        <button class="btn-acao" style="background:#25D366;" onclick="enviarWhatsApp()">üì≤ WhatsApp</button>
        <button class="btn-acao" style="background:#0066cc;" onclick="enviarEmail()">üìß E-mail</button>
        <button class="btn-acao" style="background:#999;" onclick="fecharModal()">Cancelar</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <script>
    // 1. INICIALIZA√á√ÉO E CHAVES
    const supabaseUrl = "https://xwidfuieyleqfddsupnl.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh3aWRmdWlleWxlcWZkZHN1cG5sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5Njg4NzAsImV4cCI6MjA4NzU0NDg3MH0.7OwPJNt7IOYXdjMh27gAlKz_vSwmsXD8iTJNNHXGBTs";
    
    const clienteSupabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    // INICIALIZA O EMAILJS (Coloque sua chave p√∫blica aqui)
    emailjs.init("lycdmjrdHE0nwBOTT");

    // Vari√°vel para guardar os dados de quem o admin clicou
    let candidatoAlvo = null;

    // 2. FUN√á√ïES DE AUTENTICA√á√ÉO
    async function checarSessao() {
      const { data: { session } } = await clienteSupabase.auth.getSession();
      if (session) {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('dashboardScreen').style.display = 'block';
        carregarCandidatos();
      } else {
        document.getElementById('loginScreen').style.display = 'block';
      }
    }
    
    checarSessao();

    async function fazerLogin() {
      const email = document.getElementById('adminEmail').value;
      const senha = document.getElementById('adminSenha').value;
      const msgerro = document.getElementById('loginErro');
      
      msgerro.innerText = "Entrando...";
      msgerro.style.color = "blue";
      
      const { data, error } = await clienteSupabase.auth.signInWithPassword({ email, password: senha });
      
      if (error) {
        msgerro.innerText = 'Erro: E-mail ou senha inv√°lidos.';
        msgerro.style.color = "red";
      } else {
        location.reload(); 
      }
    }

    async function fazerLogout() {
      await clienteSupabase.auth.signOut();
      location.reload();
    }

    // 3. FUN√á√ÉO DE BUSCA DOS DADOS (O DASHBOARD)
    async function carregarCandidatos() {
      const filtro = document.getElementById('filtroCargo').value;
      const tbody = document.getElementById('tabelaCorpo');
      
      tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Buscando curr√≠culos...</td></tr>';

      let query = clienteSupabase.from('candidatos').select('*').order('criado_em', { ascending: false });
      
      if (filtro !== 'Todos') {
        query = query.eq('cargo', filtro);
      }

      const { data: candidatos, error } = await query;

      if (error || candidatos.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">Nenhum candidato encontrado.</td></tr>';
        return;
      }

      tbody.innerHTML = '';
      
      candidatos.forEach(cand => {
        const dataFormatada = new Date(cand.criado_em).toLocaleDateString('pt-BR');
        const tr = document.createElement('tr');
        
        // Renderiza a linha.
        tr.innerHTML = `
          <td>${dataFormatada}</td>
          <td><strong>${cand.nome}</strong></td>
          <td>${cand.cargo}</td>
          <td>${cand.idade} anos<br><small>${cand.sexo}</small></td>
          <td>${cand.telefone}<br><small>${cand.email}</small></td>
          <td>
            <a href="${cand.curriculo_url}" target="_blank" style="color: #0066cc; text-decoration: none; font-weight: bold; margin-bottom: 5px; display: inline-block;">üìÑ Curr√≠culo</a><br>
            <a href="${cand.video_url}" target="_blank" style="color: #27ae60; text-decoration: none; font-weight: bold; display: inline-block;">üé• V√≠deo</a>
          </td>
          <td>
            <button class="btn-acao btn-agendar" onclick="abrirModal('${cand.nome}', '${cand.telefone}', '${cand.email}', '${cand.cargo}')">Agendar</button>
            <button class="btn-acao btn-excluir" onclick="deletarCandidato('${cand.id}', '${cand.nome}')">Excluir</button>
          </td>
        `;
        
        tbody.appendChild(tr);
      });
    }

    // 4. FUN√á√ïES DE A√á√ÉO (EXCLUIR E AGENDAR)
    
    // Deletar do banco
    async function deletarCandidato(id, nome) {
      if(!confirm(`‚ö†Ô∏è Tem certeza que deseja excluir o candidato ${nome}?`)) return;
      
      const { error } = await clienteSupabase.from('candidatos').delete().eq('id', id);
      
      if(error) {
        alert("Erro ao excluir. O RLS de delete foi configurado no Supabase?");
      } else {
        carregarCandidatos(); // Atualiza a tabela na hora
      }
    }

    // Abrir e fechar a janelinha
    function abrirModal(nome, telefone, email, cargo) {
      candidatoAlvo = { nome, telefone, email, cargo };
      document.getElementById('candNomeT').innerText = nome;
      document.getElementById('modalAgendamento').style.display = 'flex';
    }

    function fecharModal() {
      document.getElementById('modalAgendamento').style.display = 'none';
    }

    // Disparar WhatsApp via API gratuita
    function enviarWhatsApp() {
      const data = document.getElementById('dataEntrevista').value;
      const hora = document.getElementById('horaEntrevista').value;
      const local = document.getElementById('localEntrevista').value;

      if(!data || !hora) return alert("Preencha a data e o hor√°rio.");

      const dataBr = data.split('-').reverse().join('/');
      const numeroLimpo = candidatoAlvo.telefone.replace(/\D/g, ''); // Tira tra√ßos e espa√ßos

      const mensagem = `Ol√° ${candidatoAlvo.nome}, tudo bem? Aqui √© do setor de RH.\n\nAnalisamos seu curr√≠culo para a vaga de *${candidatoAlvo.cargo}* e voc√™ foi selecionado(a) para uma entrevista! üéâ\n\nüóìÔ∏è *Data:* ${dataBr}\n‚è∞ *Hor√°rio:* ${hora}\nüìç *Local:* ${local}\n\nPor favor, confirme sua presen√ßa.`;

      window.open(`https://wa.me/55${numeroLimpo}?text=${encodeURIComponent(mensagem)}`, '_blank');
      fecharModal();
    }

    // Disparar E-mail via EmailJS
    async function enviarEmail() {
      const data = document.getElementById('dataEntrevista').value;
      const hora = document.getElementById('horaEntrevista').value;
      const local = document.getElementById('localEntrevista').value;

      if(!data || !hora) return alert("Preencha a data e o hor√°rio.");
      
      const dataBr = data.split('-').reverse().join('/');
      const btnEmail = event.target;
      
      btnEmail.innerText = "Enviando...";
      btnEmail.disabled = true;

      try {

        await emailjs.send("service_dnul1wp", "template_h80jzoq", {
          email_candidato: candidatoAlvo.email,
          nome_candidato: candidatoAlvo.nome,
          cargo: candidatoAlvo.cargo,
          data: dataBr,
          hora: hora,
          local: local
        });
        alert("E-mail de entrevista enviado com sucesso!");
        fecharModal();
      } catch (error) {
        alert("Erro ao enviar o e-mail.");
        console.error(error);
      } finally {
        btnEmail.innerText = "üìß E-mail";
        btnEmail.disabled = false;
      }
    }
  </script>
</body>
</html>